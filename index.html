<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xkay Store ‚Ä¢ Convert & Topup PayPal</title>

  <!-- Tailwind -->
  <script>
    window.tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <meta name="theme-color" content="#0d47a1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='%23133a7c'/><stop offset='100%' stop-color='%230d47a1'/></linearGradient></defs><rect width='100' height='100' rx='18' fill='url(%23g)'/><text x='50%' y='57%' font-size='56' text-anchor='middle' fill='white' font-family='Arial, sans-serif'>X</text></svg>"/>

  <style>
    /* Scrollbar */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#2b3f83;border-radius:999px}
    ::-webkit-scrollbar-track{background:transparent}

    /* Sticky thead for scrollable table */
    thead.sticky th { position: sticky; top: 0; z-index: 2; }

    /* Light theme tokens (toggle via .theme-light on body) */
    body.theme-light { color:#0f172a; background: radial-gradient(90% 90% at 50% 10%, #e9f1ff 0%, #e3ebff 40%, #eef3ff 100%) fixed; }
    body.theme-light .glass { background: rgba(255,255,255,0.75) !important; color:#0f172a !important; border-color: rgba(0,0,0,0.08) !important; }
    body.theme-light .glass-strong { background: rgba(255,255,255,0.92) !important; }
    body.theme-light .muted { color:#334155 !important; }

    .btn { transition: transform .06s ease, opacity .2s ease; }
    .btn:active { transform: translateY(1px) scale(.99); }

    /* Prevent layout shift on mobile when toast shows */
    body { min-height: 100dvh; }
  </style>
</head>

<body class="min-h-screen text-white bg-gradient-to-br from-[#0f172a] via-[#0b2454] to-[#0a1a3a] selection:bg-white/20 selection:text-white">
  <!-- Header -->
  <header class="glass-strong sticky top-0 z-40 backdrop-blur-md bg-white/10 ring-1 ring-white/15">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-white/10 ring-1 ring-white/15 grid place-items-center">
          <span class="text-xl font-bold">X</span>
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-bold tracking-tight">Xkay Store</h1>
          <p class="text-xs sm:text-sm text-white/70 muted">Convert & Topup PayPal ‚Ä¢ cepat & aman</p>
        </div>
      </div>

      <div class="flex items-center gap-2 sm:gap-3">
        <button id="themeToggle" class="btn px-3 py-2 rounded-xl bg-white/10 ring-1 ring-white/15 hover:bg-white/20">üåô/‚òÄÔ∏è</button>
        <div class="hidden sm:flex items-center gap-3 text-sm">
          <div class="glass px-3 py-2 rounded-xl bg-white/10 ring-1 ring-white/10">
            <div class="text-white/60 muted">Convert (tetap)</div>
            <div id="rateFixedConvert" class="font-semibold">Rp 12.000</div>
          </div>
          <div class="glass px-3 py-2 rounded-xl bg-white/10 ring-1 ring-white/10">
            <div class="text-white/60 muted">Topup (tetap)</div>
            <div id="rateFixedTopup" class="font-semibold">Rp 17.000</div>
          </div>
          <div class="glass px-3 py-2 rounded-xl bg-white/10 ring-1 ring-white/10">
            <div class="text-white/60 muted">Kurs real-time</div>
            <div id="rateLive" class="font-semibold">Memuat‚Ä¶</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero / Form + Info -->
  <main class="relative">
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute -top-24 left-1/2 -translate-x-1/2 w-[900px] h-[900px] rounded-full bg-blue-500/20 blur-3xl"></div>
    </div>

    <section class="max-w-6xl mx-auto px-4 pt-6 pb-4 grid gap-6 md:grid-cols-2">
      <!-- Card: Order -->
      <div class="glass rounded-2xl bg-white/10 ring-1 ring-white/15 shadow-2xl p-5 sm:p-6">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-xl font-semibold">Buat Order</h2>
          <button id="themeToggleSm" class="btn sm:hidden px-3 py-2 rounded-xl bg-white/10 ring-1 ring-white/15 hover:bg-white/20">Tema</button>
        </div>
        <p class="text-white/70 text-sm mb-5 muted">Tanpa login. Detail dikirim ke WhatsApp Admin & tersimpan di riwayat.</p>

        <form id="orderForm" class="space-y-4" novalidate>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1 text-white/80 muted">Nama Lengkap</label>
              <input id="name" type="text" autocomplete="name" required
                class="w-full rounded-xl px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nama Anda" />
            </div>
            <div>
              <label class="block text-sm mb-1 text-white/80 muted">Email PayPal</label>
              <input id="paypal_email" type="email" autocomplete="email" required
                class="w-full rounded-xl px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="email@paypal.com" />
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1 text-white/80 muted">Jenis Transaksi</label>
              <select id="type" required
                class="w-full rounded-xl px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="convert">Convert (PayPal ‚Üí Bank/E-Wallet)</option>
                <option value="topup">Topup (Bank/E-Wallet ‚Üí PayPal)</option>
              </select>
            </div>

            <div>
              <label class="block text-sm mb-1 text-white/80 muted">Tujuan Penerimaan</label>
              <button type="button" id="providerBtn"
                class="btn w-full rounded-xl px-3 py-2 bg-blue-600 hover:bg-blue-500 transition focus:outline-none focus:ring-2 focus:ring-blue-300">
                Pilih Bank / E-Wallet
              </button>
              <p id="selectedProvider" class="text-xs text-white/70 mt-1 muted">Belum dipilih</p>
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1 text-white/80 muted">No Rekening / Akun</label>
              <input id="account" type="text" required
                class="w-full rounded-xl px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Contoh: 1234567890 (BCA)" />
            </div>
            <div>
              <label class="block text-sm mb-1 text-white/80 muted">Nominal (USD)</label>
              <input id="usd" type="number" step="0.01" min="0.01" required
                class="w-full rounded-xl px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0.00" />
              <p class="text-xs text-white/70 mt-1 muted">Dihitung pakai kurs tetap per jenis transaksi.</p>
            </div>
          </div>

          <div class="flex items-center justify-between rounded-xl bg-white/5 ring-1 ring-white/10 px-3 py-2 glass">
            <span class="text-sm text-white/80 muted">Setara (IDR, kurs tetap):</span>
            <span id="idr" class="font-semibold">Rp 0</span>
          </div>

          <button id="submitBtn" type="submit"
            class="btn w-full rounded-xl bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-3 transition focus:outline-none focus:ring-2 focus:ring-emerald-300">
            Kirim Order via WhatsApp
          </button>
          <p class="text-[11px] text-white/60 muted">Dengan mengirim, Anda setuju data disimpan untuk riwayat transaksi.</p>
        </form>
      </div>

      <!-- Card: Kurs & Info -->
      <aside class="glass rounded-2xl bg-white/10 ring-1 ring-white/10 p-5 sm:p-6">
        <h3 class="text-lg font-semibold mb-2">Informasi Kurs</h3>
        <ul class="space-y-2 text-sm text-white/80 muted">
          <li>‚Ä¢ <b>Kurs tetap</b> dipakai untuk hitungan IDR (Convert & Topup berbeda).</li>
          <li>‚Ä¢ <b>Kurs real-time</b> hanya info pasar (tidak memengaruhi perhitungan).</li>
          <li>‚Ä¢ Hubungi Admin WhatsApp untuk konfirmasi final.</li>
        </ul>

        <div class="mt-4 grid gap-3">
          <div class="glass rounded-xl bg-white/10 ring-1 ring-white/10 p-3">
            <div class="text-white/60 muted text-sm">Convert (tetap)</div>
            <div id="fixedConvertBig" class="mt-1 text-2xl font-bold">Rp 12.000</div>
          </div>
          <div class="glass rounded-xl bg-white/10 ring-1 ring-white/10 p-3">
            <div class="text-white/60 muted text-sm">Topup (tetap)</div>
            <div id="fixedTopupBig" class="mt-1 text-2xl font-bold">Rp 17.000</div>
          </div>
          <div class="glass rounded-xl bg-white/10 ring-1 ring-white/10 p-3">
            <div class="flex items-center justify-between">
              <span class="text-sm text-white/70 muted">Kurs Real-Time</span>
              <button id="refreshRate" class="btn text-xs px-2 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300">Refresh</button>
            </div>
            <div class="mt-1">
              <div id="liveRateBig" class="text-2xl font-bold">Memuat‚Ä¶</div>
              <div id="liveMeta" class="text-[11px] text-white/60 mt-1 muted">Sumber: ‚Äî</div>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <!-- Riwayat -->
    <section class="max-w-6xl mx-auto px-4 pt-2 pb-10">
      <div class="glass rounded-2xl bg-white/10 ring-1 ring-white/10 p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <h2 class="text-xl font-semibold">Riwayat Transaksi</h2>
          <div class="flex items-center gap-2">
            <button id="reloadHistory" class="btn px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500">Reload</button>
            <button id="exportBtn" class="btn px-3 py-2 rounded-lg bg-yellow-400 text-black font-semibold">Export CSV</button>
          </div>
        </div>

        <div class="rounded-xl ring-1 ring-white/10 glass-strong overflow-hidden">
          <!-- SCROLLABLE WRAPPER -->
          <div class="max-h-[420px] overflow-y-auto">
            <table class="min-w-full text-left text-sm">
              <thead class="sticky bg-white/10 text-white/80">
                <tr>
                  <th class="px-3 py-2">Tanggal</th>
                  <th class="px-3 py-2">Tipe</th>
                  <th class="px-3 py-2">Kategori</th>
                  <th class="px-3 py-2">Provider</th>
                  <th class="px-3 py-2">Nama</th>
                  <th class="px-3 py-2">USD</th>
                  <th class="px-3 py-2">IDR</th>
                </tr>
              </thead>
              <tbody id="history" class="divide-y divide-white/10">
                <tr class="animate-pulse"><td class="px-3 py-2" colspan="7">Memuat data‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <p id="historyEmpty" class="hidden text-center text-white/60 text-sm mt-3 muted">Belum ada transaksi.</p>
      </div>
    </section>
  </main>

  <!-- Modal Provider -->
  <div id="providerModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="providerTitle">
    <div id="providerOverlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative mx-auto mt-20 w-[92%] max-w-md rounded-2xl bg-white text-black shadow-2xl ring-1 ring-black/10">
      <div class="p-5">
        <div class="flex items-center justify-between">
          <h3 id="providerTitle" class="text-lg font-semibold">Pilih Bank / E-Wallet</h3>
          <button id="closeProvider" class="rounded-lg px-2 py-1 text-sm bg-black/5 hover:bg-black/10">Tutup (Esc)</button>
        </div>

        <p class="mt-3 mb-1 text-sm font-semibold text-black/70">Bank Lokal</p>
        <div class="grid grid-cols-2 gap-3">
          <button data-category="Bank Lokal" data-provider="BCA" class="opt-btn">BCA</button>
          <button data-category="Bank Lokal" data-provider="BRI" class="opt-btn">BRI</button>
          <button data-category="Bank Lokal" data-provider="BNI" class="opt-btn">BNI</button>
          <button data-category="Bank Lokal" data-provider="Mandiri" class="opt-btn">Mandiri</button>
        </div>

        <p class="mt-4 mb-1 text-sm font-semibold text-black/70">E-Wallet</p>
        <div class="grid grid-cols-2 gap-3">
          <button data-category="E-Wallet" data-provider="OVO" class="opt-btn">OVO</button>
          <button data-category="E-Wallet" data-provider="Dana" class="opt-btn">Dana</button>
          <button data-category="E-Wallet" data-provider="GoPay" class="opt-btn">GoPay</button>
          <button data-category="E-Wallet" data-provider="ShopeePay" class="opt-btn">ShopeePay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-white text-black text-sm shadow-xl"></div>

  <script type="module">
    // ====== KONFIG (ubah jika perlu) ======
    const SUPABASE_URL  = "https://rhujpinlutjiztyonmas.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJodWpwaW5sdXRqaXp0eW9ubWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDQyOTIsImV4cCI6MjA3Mjg4MDI5Mn0.zcfDUOHTeBYydFFscwmy3U9yryHiItTVJPLRurUlBvY";
    const WA_ADMIN      = "6285846005280";

    // Kurs tetap (terpisah & non-editable via UI)
    const FIXED_RATE_CONVERT = 12000;
    const FIXED_RATE_TOPUP   = 17000;

    // ====== STATE ======
    const idLocale = "id-ID";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    let LIVE_RATE  = FIXED_RATE_CONVERT;
    let selected   = { category: null, provider: null };
    let modalOpener = null;
    let submitting = false;

    // ====== HELPERS ======
    const qs  = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    const rp  = (n) => new Intl.NumberFormat(idLocale, { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(n);
    const fmt = (n) => new Intl.NumberFormat(idLocale, { maximumFractionDigits: 2 }).format(n);

    function toast(msg, ok=true){
      const el = qs("#toast"); el.textContent = msg;
      el.className = "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-sm shadow-xl " + (ok ? "bg-emerald-400 text-black" : "bg-red-400 text-black");
      el.style.display = "block"; setTimeout(()=>{ el.style.display="none"; }, 2200);
    }

    function currentFixedRate(){
      return qs("#type").value === "convert" ? FIXED_RATE_CONVERT : FIXED_RATE_TOPUP;
    }
    function updateComputedIDR(){
      const usd = parseFloat(qs("#usd").value) || 0;
      qs("#idr").textContent = rp(Math.round(usd * currentFixedRate()));
    }
    function setFixedRateUI(){
      qs("#rateFixedConvert").textContent = rp(FIXED_RATE_CONVERT);
      qs("#rateFixedTopup").textContent   = rp(FIXED_RATE_TOPUP);
      qs("#fixedConvertBig").textContent  = rp(FIXED_RATE_CONVERT);
      qs("#fixedTopupBig").textContent    = rp(FIXED_RATE_TOPUP);
      updateComputedIDR();
    }

    // ====== THEME ======
    const THEME_KEY = "xkay_theme";
    function applyTheme(t){
      const body = document.body;
      if(t === "light"){ body.classList.add("theme-light"); document.documentElement.classList.remove("dark"); }
      else { body.classList.remove("theme-light"); document.documentElement.classList.add("dark"); }
      localStorage.setItem(THEME_KEY, t);
    }
    function toggleTheme(){
      applyTheme((localStorage.getItem(THEME_KEY) || "dark") === "dark" ? "light" : "dark");
    }

    // ====== LIVE RATE (3 sumber + timeout + fallback) ======
    const FETCH_TIMEOUT = 8000;
    function fetchTimeout(url, ms=FETCH_TIMEOUT){
      return Promise.race([
        fetch(url),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), ms))
      ]);
    }
    async function src_exchangerate_host(){
      const r = await fetchTimeout("https://api.exchangerate.host/latest?base=USD&symbols=IDR");
      const j = await r.json(); const v = Number(j?.rates?.IDR); if(!v) throw new Error("invalid data"); return { rate: Math.round(v), src: "exchangerate.host" };
    }
    async function src_open_er_api(){
      const r = await fetchTimeout("https://open.er-api.com/v6/latest/USD");
      const j = await r.json(); const v = Number(j?.rates?.IDR); if(!v) throw new Error("invalid data"); return { rate: Math.round(v), src: "open.er-api.com" };
    }
    async function src_frankfurter(){
      const r = await fetchTimeout("https://api.frankfurter.app/latest?from=USD&to=IDR");
      const j = await r.json(); const v = Number(j?.rates?.IDR); if(!v) throw new Error("invalid data"); return { rate: Math.round(v), src: "frankfurter.app" };
    }
    async function loadLiveRate(){
      const small = qs("#rateLive");
      const big   = qs("#liveRateBig");
      const meta  = qs("#liveMeta");
      small.textContent = big.textContent = "Memuat‚Ä¶";
      try{
        const sources = [src_exchangerate_host(), src_open_er_api(), src_frankfurter()];
        let result;
        if (Promise.any) {
          result = await Promise.any(sources);
        } else {
          // simple first-success polyfill
          result = await new Promise((resolve, reject)=>{
            let fails = 0;
            sources.forEach(p => p.then(resolve).catch(()=>{ if(++fails === sources.length) reject(new Error("all failed")); }));
          });
        }
        LIVE_RATE = result.rate;
        small.textContent = rp(LIVE_RATE);
        big.textContent   = rp(LIVE_RATE);
        meta.textContent  = `Sumber: ${result.src} ‚Ä¢ ${new Date().toLocaleString(idLocale)}`;
      }catch(e){
        console.warn("live rate failed:", e);
        LIVE_RATE = currentFixedRate(); // fallback
        small.textContent = rp(LIVE_RATE);
        big.textContent   = rp(LIVE_RATE);
        meta.textContent  = "Gagal muat kurs real-time (pakai fallback).";
      }
    }

    // ====== PROVIDER MODAL ======
    const modal = qs("#providerModal");
    const overlay = qs("#providerOverlay");
    const providerBtn = qs("#providerBtn");
    const closeProvider = qs("#closeProvider");
    const baseOptBtn = "opt-btn px-3 py-2 rounded-xl bg-black/5 hover:bg-black/10 ring-1 ring-black/10 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm";
    qsa(".opt-btn").forEach(b=> b.className = baseOptBtn);

    function openModal(){
      modalOpener = document.activeElement;
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden","false");
      const first = modal.querySelector(".opt-btn"); first && first.focus();
      document.addEventListener("keydown", onEscClose);
    }
    function closeModal(){
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden","true");
      document.removeEventListener("keydown", onEscClose);
      if(modalOpener) modalOpener.focus();
    }
    function onEscClose(e){ if(e.key === "Escape") closeModal(); }

    providerBtn.addEventListener("click", openModal, { passive:true });
    closeProvider.addEventListener("click", closeModal, { passive:true });
    overlay.addEventListener("click", closeModal, { passive:true });

    modal.addEventListener("click", (e)=>{
      const btn = e.target.closest(".opt-btn");
      if(!btn) return;
      selected.category = btn.dataset.category;
      selected.provider = btn.dataset.provider;
      qs("#selectedProvider").textContent = `${selected.category} ‚Äî ${selected.provider}`;
      toast("Metode dipilih: " + selected.provider);
      closeModal();
    });

    // ====== VALIDASI ======
    const isEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    const isName  = (v) => v && v.trim().length >= 3;
    const isAcct  = (v) => /^[a-zA-Z0-9.\-_ ]{5,}$/.test(v.trim());

    // ====== FORM ======
    const orderForm = qs("#orderForm");
    const submitBtn = qs("#submitBtn");
    ["input","change"].forEach(evt=>{
      qs("#usd").addEventListener(evt, updateComputedIDR, { passive:true });
      qs("#type").addEventListener(evt, updateComputedIDR, { passive:true });
    });

    orderForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(submitting) return;
      submitting = true; submitBtn.disabled = true; submitBtn.textContent = "Memproses‚Ä¶";

      const name = qs("#name").value.trim();
      const email = qs("#paypal_email").value.trim();
      const type = qs("#type").value;
      const account = qs("#account").value.trim();
      const usd = Math.max(0, parseFloat(qs("#usd").value) || 0);
      const rate = currentFixedRate();
      const idr = Math.round(usd * rate);

      if(!selected.provider){ toast("Pilih Bank / E-Wallet dulu.", false); return endSubmit(); }
      if(!isName(name)){ toast("Nama minimal 3 karakter.", false); return endSubmit(); }
      if(!isEmail(email)){ toast("Email tidak valid.", false); return endSubmit(); }
      if(!isAcct(account)){ toast("Akun/Rekening minimal 5 karakter (huruf/angka .-_ spasi).", false); return endSubmit(); }
      if(!(usd > 0)){ toast("Nominal USD harus lebih dari 0.", false); return endSubmit(); }

      // Simpan ke DB (best-effort)
      try{
        const { error } = await supabaseClient.from("orders").insert([{
          type, name, paypal_email: email,
          usd, rate, receive_idr: idr,
          target_type: selected.category, provider: selected.provider, account
        }]);
        if(error) throw error;
        toast("Order tersimpan. Membuka WhatsApp‚Ä¶", true);
      }catch(err){
        console.error("[DB] insert gagal:", err);
        toast("Gagal simpan DB‚Äîtetap membuka WhatsApp.", false);
      }

      // Kirim ke WhatsApp
      const waMsg = [
        `Halo Admin Xkay Store, saya ingin ${type}:`,
        ``,
        `Nama: ${name}`,
        `Email PayPal: ${email}`,
        `Kategori: ${selected.category}`,
        `Provider: ${selected.provider}`,
        `Akun: ${account}`,
        `Nominal: ${fmt(usd)} USD = ${rp(idr)} (kurs tetap ${rp(rate)})`,
        `Kurs real-time saat ini: ${rp(LIVE_RATE)}`
      ].join("\n");
      window.open(`https://wa.me/${encodeURIComponent(WA_ADMIN)}?text=${encodeURIComponent(waMsg)}`, "_blank", "noopener");

      orderForm.reset();
      selected = { category:null, provider:null };
      qs("#selectedProvider").textContent = "Belum dipilih";
      updateComputedIDR();
      await loadHistory();
      endSubmit();
    });

    function endSubmit(){
      submitting = false; submitBtn.disabled = false; submitBtn.textContent = "Kirim Order via WhatsApp";
    }

    // ====== RIWAYAT ======
    async function loadHistory(){
      const tbody = qs("#history");
      const empty = qs("#historyEmpty");
      tbody.innerHTML = `<tr class="animate-pulse"><td class="px-3 py-2" colspan="7">Memuat data‚Ä¶</td></tr>`;
      empty.classList.add("hidden");
      try{
        const { data, error } = await supabaseClient.from("orders").select("*").order("created_at", { ascending:false }).limit(200);
        if(error) throw error;
        tbody.innerHTML = "";
        if(!data || !data.length){ empty.classList.remove("hidden"); return; }
        for(const row of data){
          const tr = document.createElement("tr");
          const cells = [
            new Date(row.created_at).toLocaleString(idLocale),
            row.type ?? "-",
            row.target_type ?? "-",
            row.provider ?? "-",
            row.name ?? "-",
            (row.usd ?? 0).toLocaleString(idLocale, { maximumFractionDigits: 2 }),
            rp(row.receive_idr ?? 0)
          ];
          for(const c of cells){
            const td = document.createElement("td");
            td.className = "px-3 py-2";
            td.textContent = c;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
      }catch(e){
        console.error("[DB] load history gagal:", e);
        tbody.innerHTML = "";
        empty.classList.remove("hidden");
        empty.textContent = "Gagal memuat riwayat. Coba Reload.";
      }
    }

    async function exportCSV(){
      try{
        const { data, error } = await supabaseClient.from("orders").select("*").order("created_at",{ascending:false});
        if(error) throw error;
        const head = ["Tanggal","Tipe","Kategori","Provider","Nama","USD","IDR"];
        const rows = (data||[]).map(r => [
          r.created_at, r.type||"", r.target_type||"", r.provider||"", r.name||"", r.usd||0, r.receive_idr||0
        ]);
        const csv = [head, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "riwayat_xkay_store.csv"; a.click();
        URL.revokeObjectURL(url);
        toast("CSV terunduh");
      }catch(e){
        console.error("[CSV] export gagal:", e);
        toast("Gagal export CSV.", false);
      }
    }

    // ====== BINDINGS ======
    qs("#refreshRate").addEventListener("click", loadLiveRate, { passive:true });
    qs("#reloadHistory").addEventListener("click", loadHistory, { passive:true });
    qs("#exportBtn").addEventListener("click", exportCSV, { passive:true });
    qs("#themeToggle").addEventListener("click", toggleTheme, { passive:true });
    qs("#themeToggleSm").addEventListener("click", toggleTheme, { passive:true });

    // ====== INIT ======
    (async function init(){
      applyTheme(localStorage.getItem(THEME_KEY) || "dark");
      qsa(".opt-btn").forEach(b=> b.className = "opt-btn px-3 py-2 rounded-xl bg-black/5 hover:bg-black/10 ring-1 ring-black/10 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm");
      setFixedRateUI();
      await loadLiveRate();
      setInterval(loadLiveRate, 10 * 60 * 1000); // refresh tiap 10 menit
      await loadHistory();
      updateComputedIDR();
    })();
  </script>
</body>
</html>
