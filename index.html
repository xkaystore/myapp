<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xkay Store • Convert & Topup PayPal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.tailwind = {
      config: {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              // Dark Theme
              dark: {
                bg: '#0D1117',
                'bg-secondary': '#161B22',
                card: '#1A2029',
                border: '#30363D',
                text: '#E6EDF3',
                'text-muted': '#8B949E',
              },
              // Light Theme
              light: {
                bg: '#F3F4F6',
                'bg-secondary': '#FFFFFF',
                card: '#FFFFFF',
                border: '#D1D5DB',
                text: '#1F2937',
                'text-muted': '#6B7280',
              },
              accent: {
                DEFAULT: '#2563EB',
                hover: '#1D4ED8',
              },
            },
          },
        },
      }
    };
  </script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <meta name="theme-color" content="#1D4ED8" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='%232563EB'/><stop offset='100%' stop-color='%231D4ED8'/></linearGradient></defs><rect width='100' height='100' rx='22' fill='url(%23g)'/><text x='50%' y='57%' font-size='56' text-anchor='middle' fill='white' font-family='Inter, Arial, sans-serif' font-weight='600'>X</text></svg>"/>

  <style>
    /* Base Styles */
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .card-glass {
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
    }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #30363D; border-radius: 999px; }
    ::-webkit-scrollbar-track { background: transparent; }
    html.light ::-webkit-scrollbar-thumb { background: #D1D5DB; }

    /* Sticky Header for Table */
    .table-container thead th { position: sticky; top: 0; z-index: 1; }
    
    /* Transitions */
    .btn, .opt-btn, input, select {
        transition: transform 0.1s ease, box-shadow 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
    }
    .btn:active, .opt-btn:active {
        transform: translateY(1px) scale(0.98);
    }
    
    /* Focus Ring */
    input:focus, select:focus, button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.4);
    }
    
    /* Skeleton Loader */
    .skeleton {
        position: relative;
        overflow: hidden;
        background-color: rgba(128, 128, 128, 0.2);
    }
    .skeleton::after {
        content: '';
        position: absolute;
        top: 0;
        left: -150%;
        width: 150%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
        0% { left: -150%; }
        100% { left: 150%; }
    }
  </style>
</head>

<body class="bg-dark-bg text-dark-text min-h-screen antialiased selection:bg-accent/30">
  
  <header class="card-glass sticky top-0 z-40 bg-dark-card/75 ring-1 ring-dark-border">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-accent grid place-items-center">
                    <span class="text-xl font-semibold text-white">X</span>
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold tracking-tight text-dark-text">Xkay Store</h1>
                    <p class="text-xs sm:text-sm text-dark-text-muted">Convert & Topup PayPal • Cepat & Aman</p>
                </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-3">
                <div class="hidden sm:flex items-center gap-3 text-sm">
                    <div class="text-center"><div class="text-dark-text-muted">Convert</div><div id="rateFixedConvert" class="font-semibold"></div></div>
                    <div class="text-center"><div class="text-dark-text-muted">Topup</div><div id="rateFixedTopup" class="font-semibold"></div></div>
                    <div class="text-center"><div class="text-dark-text-muted">Live</div><div id="rateLive" class="font-semibold min-w-[70px]"></div></div>
                </div>
                <button id="themeToggle" class="btn p-2 rounded-full hover:bg-dark-border/50" aria-label="Toggle theme">
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </button>
            </div>
        </div>
    </div>
  </header>

  <main class="relative py-8 sm:py-12">
    <div aria-hidden="true" class="absolute inset-0 pointer-events-none">
        <div class="absolute -top-32 left-1/2 -translate-x-1/2 w-[80vw] max-w-4xl h-[500px] rounded-full bg-accent/10 blur-3xl"></div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid gap-8 lg:grid-cols-5 relative">
        <div class="lg:col-span-3 card-glass bg-dark-card/75 ring-1 ring-dark-border rounded-2xl p-6 sm:p-8">
            <h2 class="text-2xl font-bold mb-1 text-dark-text">Buat Pesanan Baru</h2>
            <p class="text-dark-text-muted text-sm mb-6">Detail akan dikirim ke WhatsApp Admin dan tersimpan di riwayat.</p>

            <form id="orderForm" class="space-y-4" novalidate>
                <div class="grid sm:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium mb-1.5 text-dark-text-muted">Nama Lengkap</label>
                        <input id="name" type="text" autocomplete="name" required class="form-input" placeholder="Nama Anda" />
                    </div>
                    <div>
                        <label for="paypal_email" class="block text-sm font-medium mb-1.5 text-dark-text-muted">Email PayPal</label>
                        <input id="paypal_email" type="email" autocomplete="email" required class="form-input" placeholder="email@paypal.com" />
                    </div>
                </div>

                <div class="grid sm:grid-cols-2 gap-4">
                    <div>
                        <label for="type" class="block text-sm font-medium mb-1.5 text-dark-text-muted">Jenis Transaksi</label>
                        <select id="type" required class="form-input">
                            <option value="convert">Convert (PayPal → Tujuan)</option>
                            <option value="topup">Topup (Tujuan → PayPal)</option>
                        </select>
                    </div>
                    <div>
                        <label for="providerBtn" class="block text-sm font-medium mb-1.5 text-dark-text-muted">Tujuan Penerimaan</label>
                        <button type="button" id="providerBtn" class="btn w-full h-10 rounded-lg px-3 bg-dark-bg-secondary hover:bg-dark-border/50 ring-1 ring-dark-border">
                            Pilih Bank / E-Wallet
                        </button>
                        <p id="selectedProvider" class="text-xs text-dark-text-muted mt-1.5">Belum dipilih</p>
                    </div>
                </div>

                <div class="grid sm:grid-cols-2 gap-4">
                    <div>
                        <label for="account" class="block text-sm font-medium mb-1.5 text-dark-text-muted">No. Rekening / Akun</label>
                        <input id="account" type="text" required class="form-input" placeholder="Contoh: 1234567890" />
                    </div>
                    <div>
                        <label for="usd" class="block text-sm font-medium mb-1.5 text-dark-text-muted">Nominal (USD)</label>
                        <input id="usd" type="number" step="0.01" min="0.01" required class="form-input" placeholder="0.00" />
                    </div>
                </div>

                <div class="flex items-center justify-between rounded-lg bg-dark-bg-secondary p-3">
                    <span class="text-sm text-dark-text-muted">Estimasi diterima (IDR):</span>
                    <span id="idr" class="font-semibold text-lg text-dark-text">Rp 0</span>
                </div>

                <button id="submitBtn" type="submit" class="btn w-full rounded-lg bg-accent hover:bg-accent-hover text-white font-semibold py-3">
                    <span>Kirim Order via WhatsApp</span>
                    <svg class="w-5 h-5 ml-2 hidden" id="submit-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <p class="text-[11px] text-center text-dark-text-muted">Dengan mengirim, Anda setuju data disimpan untuk riwayat transaksi.</p>
            </form>
        </div>

        <aside class="lg:col-span-2 space-y-8">
            <div class="card-glass bg-dark-card/75 ring-1 ring-dark-border rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4 text-dark-text">Informasi Kurs</h3>
                <div class="space-y-3">
                    <div class="p-4 rounded-lg bg-dark-bg-secondary">
                        <div class="text-dark-text-muted text-sm">Convert (tetap)</div>
                        <div id="fixedConvertBig" class="mt-1 text-2xl font-bold text-dark-text"></div>
                    </div>
                    <div class="p-4 rounded-lg bg-dark-bg-secondary">
                        <div class="text-dark-text-muted text-sm">Topup (tetap)</div>
                        <div id="fixedTopupBig" class="mt-1 text-2xl font-bold text-dark-text"></div>
                    </div>
                    <div class="p-4 rounded-lg bg-dark-bg-secondary">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-dark-text-muted">Kurs Real-Time (Info)</span>
                            <button id="refreshRate" class="btn text-xs px-2 py-1 rounded-md bg-accent/80 hover:bg-accent text-white">Refresh</button>
                        </div>
                        <div class="mt-1">
                            <div id="liveRateBig" class="text-2xl font-bold text-dark-text min-h-[32px]"></div>
                            <div id="liveMeta" class="text-[11px] text-dark-text-muted mt-1"></div>
                        </div>
                    </div>
                </div>
            </aside>
            
            <div class="card-glass bg-dark-card/75 ring-1 ring-dark-border rounded-2xl p-6">
                <div class="flex items-center justify-between gap-4 mb-4">
                    <h3 class="text-lg font-bold text-dark-text">Riwayat Transaksi</h3>
                    <button id="reloadHistory" class="btn text-xs px-2 py-1 rounded-md bg-dark-bg-secondary hover:bg-dark-border/50 ring-1 ring-dark-border">Reload</button>
                </div>
                <div class="rounded-lg ring-1 ring-dark-border bg-dark-bg-secondary overflow-hidden">
                    <div class="table-container max-h-[420px] overflow-y-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-dark-card/80 card-glass text-dark-text-muted">
                                <tr>
                                    <th class="p-3">Tanggal</th><th class="p-3">Tipe</th><th class="p-3">Provider</th>
                                    <th class="p-3">Nama</th><th class="p-3">USD</th><th class="p-3">IDR</th>
                                </tr>
                            </thead>
                            <tbody id="history" class="divide-y divide-dark-border">
                                </tbody>
                        </table>
                    </div>
                </div>
                <p id="historyState" class="hidden text-center text-dark-text-muted text-sm mt-4"></p>
            </div>
        </aside>
    </div>
  </main>

  <div id="providerModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="providerTitle">
    <div id="providerOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm" aria-hidden="true"></div>
    <div class="relative mx-auto mt-20 w-[92%] max-w-md">
      <div class="rounded-2xl bg-light-bg-secondary text-light-text shadow-2xl ring-1 ring-black/10 p-5">
          <div class="flex items-center justify-between">
              <h3 id="providerTitle" class="text-lg font-semibold">Pilih Bank / E-Wallet</h3>
              <button id="closeProvider" class="btn rounded-lg px-2 py-1 text-sm bg-black/5 hover:bg-black/10">Tutup</button>
          </div>
          <p class="mt-4 mb-2 text-sm font-semibold text-light-text-muted">Bank Lokal</p>
          <div class="grid grid-cols-2 gap-3">
              <button data-category="Bank Lokal" data-provider="BCA" class="opt-btn">BCA</button>
              <button data-category="Bank Lokal" data-provider="BRI" class="opt-btn">BRI</button>
              <button data-category="Bank Lokal" data-provider="BNI" class="opt-btn">BNI</button>
              <button data-category="Bank Lokal" data-provider="Mandiri" class="opt-btn">Mandiri</button>
          </div>
          <p class="mt-4 mb-2 text-sm font-semibold text-light-text-muted">E-Wallet</p>
          <div class="grid grid-cols-2 gap-3">
              <button data-category="E-Wallet" data-provider="OVO" class="opt-btn">OVO</button>
              <button data-category="E-Wallet" data-provider="Dana" class="opt-btn">Dana</button>
              <button data-category="E-Wallet" data-provider="GoPay" class="opt-btn">GoPay</button>
              <button data-category="E-Wallet" data-provider="ShopeePay" class="opt-btn">ShopeePay</button>
          </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 flex items-center gap-3 px-4 py-2 rounded-lg text-sm font-semibold shadow-2xl transition-transform duration-300 translate-y-20 opacity-0" role="alert">
      <span id="toast-icon"></span>
      <span id="toast-msg"></span>
  </div>

  <script type="module">
    // ====== CONFIGURATION ======
    const CONFIG = {
        SUPABASE_URL: "https://rhujpinlutjiztyonmas.supabase.co",
        SUPABASE_ANON: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJodWpwaW5sdXRqaXp0eW9ubWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDQyOTIsImV4cCI6MjA3Mjg4MDI5Mn0.zcfDUOHTeBYydFFscwmy3U9yryHiItTVJPLRurUlBvY",
        WA_ADMIN: "6285846005280",
        RATES: {
            CONVERT: 12000,
            TOPUP: 17000,
        },
        FETCH_TIMEOUT: 8000,
        ID_LOCALE: "id-ID",
    };

    // ====== DOM ELEMENTS ======
    const DOMElements = {
        qs: (sel) => document.querySelector(sel),
        qsa: (sel) => Array.from(document.querySelectorAll(sel)),
        get body() { return document.body; },
        // ... (getters for other elements)
    };
    
    // ====== STATE MANAGEMENT ======
    const AppState = {
        liveRate: CONFIG.RATES.CONVERT,
        selectedProvider: { category: null, provider: null },
        isSubmitting: false,
        toastTimeout: null,
    };

    // ====== UTILITIES ======
    const Utils = {
        formatCurrency: (n) => new Intl.NumberFormat(CONFIG.ID_LOCALE, { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(n),
        formatNumber: (n) => new Intl.NumberFormat(CONFIG.ID_LOCALE, { maximumFractionDigits: 2 }).format(n),
        
        showToast(message, type = 'success') {
            const toast = DOMElements.qs("#toast");
            const icon = DOMElements.qs("#toast-icon");
            DOMElements.qs("#toast-msg").textContent = message;

            const styles = {
                success: { bg: 'bg-emerald-500', icon: '✅' },
                error: { bg: 'bg-red-500', icon: '❌' },
                info: { bg: 'bg-blue-500', icon: 'ℹ️' },
            };
            
            toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 flex items-center gap-3 px-4 py-2 rounded-lg text-sm font-semibold shadow-2xl transition-transform duration-300 text-white ${styles[type].bg}`;
            icon.textContent = styles[type].icon;

            toast.classList.remove('translate-y-20', 'opacity-0');
            clearTimeout(AppState.toastTimeout);
            AppState.toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2500);
        },
    };

    // ====== THEME MANAGER ======
    const ThemeManager = {
        init() {
            this.applyTheme(localStorage.getItem("xkay_theme") || "dark");
            DOMElements.qs("#themeToggle").addEventListener("click", () => this.toggleTheme());
        },
        applyTheme(theme) {
            const html = document.documentElement;
            html.classList.toggle("dark", theme === "dark");
            html.classList.toggle("light", theme === "light");
            DOMElements.qs("#theme-icon-dark").classList.toggle("hidden", theme === "light");
            DOMElements.qs("#theme-icon-light").classList.toggle("hidden", theme === "dark");
            localStorage.setItem("xkay_theme", theme);
        },
        toggleTheme() {
            const currentTheme = localStorage.getItem("xkay_theme") || "dark";
            this.applyTheme(currentTheme === "dark" ? "light" : "dark");
        },
    };

    // ====== API & DATA SERVICE ======
    const ApiService = {
        supabase: supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON),

        async fetchWithTimeout(url, ms = CONFIG.FETCH_TIMEOUT) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), ms);
            try {
                const response = await fetch(url, { signal: controller.signal });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                clearTimeout(timeout);
                throw error;
            }
        },

        async getLiveRate() {
            const sources = [
                async () => {
                    const data = await this.fetchWithTimeout("https://api.exchangerate.host/latest?base=USD&symbols=IDR");
                    return { rate: Math.round(data?.rates?.IDR), src: "exchangerate.host" };
                },
                async () => {
                    const data = await this.fetchWithTimeout("https://open.er-api.com/v6/latest/USD");
                    return { rate: Math.round(data?.rates?.IDR), src: "open.er-api.com" };
                },
                async () => {
                    const data = await this.fetchWithTimeout("https://api.frankfurter.app/latest?from=USD&to=IDR");
                    return { rate: Math.round(data?.rates?.IDR), src: "frankfurter.app" };
                },
            ];

            try {
                const result = await Promise.any(sources.map(s => s()));
                if (!result || !result.rate) throw new Error("Invalid data from all sources");
                return result;
            } catch (e) {
                console.warn("Live rate fetch failed:", e);
                return null;
            }
        },
        
        async getHistory() {
            const { data, error } = await this.supabase
                .from("orders")
                .select("*")
                .order("created_at", { ascending: false })
                .limit(100);
            if (error) throw error;
            return data;
        },

        async saveOrder(orderData) {
            const { error } = await this.supabase.from("orders").insert([orderData]);
            if (error) throw error;
        }
    };

    // ====== UI CONTROLLER ======
    const UIController = {
        init() {
            this.setFixedRateUI();
            this.setupEventListeners();
            this.updateComputedIDR();
            this.applyInputStyles();
        },

        setFixedRateUI() {
            const { CONVERT, TOPUP } = CONFIG.RATES;
            DOMElements.qs("#rateFixedConvert").textContent = Utils.formatCurrency(CONVERT);
            DOMElements.qs("#rateFixedTopup").textContent = Utils.formatCurrency(TOPUP);
            DOMElements.qs("#fixedConvertBig").textContent = Utils.formatCurrency(CONVERT);
            DOMElements.qs("#fixedTopupBig").textContent = Utils.formatCurrency(TOPUP);
        },

        updateLiveRateUI(result) {
            const rate = result?.rate || AppState.liveRate;
            const formattedRate = Utils.formatCurrency(rate);
            
            DOMElements.qs("#rateLive").textContent = formattedRate;
            DOMElements.qs("#liveRateBig").textContent = formattedRate;
            
            if (result) {
                DOMElements.qs("#liveMeta").textContent = `Sumber: ${result.src} • ${new Date().toLocaleTimeString(CONFIG.ID_LOCALE)}`;
            } else {
                DOMElements.qs("#liveMeta").textContent = "Gagal memuat, menggunakan fallback.";
            }
        },
        
        renderHistory(data) {
            const tbody = DOMElements.qs("#history");
            const stateEl = DOMElements.qs("#historyState");
            tbody.innerHTML = "";
            stateEl.classList.add("hidden");

            if (!data || data.length === 0) {
                stateEl.textContent = "Belum ada transaksi.";
                stateEl.classList.remove("hidden");
                return;
            }
            
            const fragment = document.createDocumentFragment();
            for (const row of data) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="p-3">${new Date(row.created_at).toLocaleDateString(CONFIG.ID_LOCALE)}</td>
                    <td class="p-3 capitalize">${row.type ?? "-"}</td>
                    <td class="p-3">${row.provider ?? "-"}</td>
                    <td class="p-3">${row.name ?? "-"}</td>
                    <td class="p-3">${Utils.formatNumber(row.usd ?? 0)}</td>
                    <td class="p-3 font-semibold">${Utils.formatCurrency(row.receive_idr ?? 0)}</td>
                `;
                fragment.appendChild(tr);
            }
            tbody.appendChild(fragment);
        },

        showHistoryLoading() {
            const tbody = DOMElements.qs("#history");
            const stateEl = DOMElements.qs("#historyState");
            stateEl.classList.add("hidden");
            tbody.innerHTML = Array(5).fill(0).map(() => `
                <tr>
                    ${Array(6).fill(0).map(() => `<td class="p-3"><div class="skeleton h-4 w-full rounded"></div></td>`).join('')}
                </tr>
            `).join('');
        },

        showHistoryError() {
            DOMElements.qs("#history").innerHTML = "";
            const stateEl = DOMElements.qs("#historyState");
            stateEl.textContent = "Gagal memuat riwayat. Coba Reload.";
            stateEl.classList.remove("hidden");
        },

        getCurrentFixedRate() {
            return DOMElements.qs("#type").value === "convert" ? CONFIG.RATES.CONVERT : CONFIG.RATES.TOPUP;
        },

        updateComputedIDR() {
            const usd = parseFloat(DOMElements.qs("#usd").value) || 0;
            const idr = Math.round(usd * this.getCurrentFixedRate());
            DOMElements.qs("#idr").textContent = Utils.formatCurrency(idr);
        },

        setupEventListeners() {
            const form = DOMElements.qs("#orderForm");
            form.addEventListener("submit", (e) => MainController.handleFormSubmit(e));
            form.addEventListener("input", (e) => {
                if (e.target.id === 'usd' || e.target.id === 'type') {
                    this.updateComputedIDR();
                }
            });

            DOMElements.qs("#refreshRate").addEventListener("click", () => MainController.loadLiveRate());
            DOMElements.qs("#reloadHistory").addEventListener("click", () => MainController.loadHistory());

            this.setupModalListeners();
        },
        
        setupModalListeners() {
            const modal = DOMElements.qs("#providerModal");
            const openBtn = DOMElements.qs("#providerBtn");
            const closeBtn = DOMElements.qs("#closeProvider");
            const overlay = DOMElements.qs("#providerOverlay");
            let modalOpener;

            const openModal = () => {
                modalOpener = document.activeElement;
                modal.classList.remove("hidden");
                DOMElements.qsa(".opt-btn")[0]?.focus();
                document.addEventListener("keydown", onEsc);
            };

            const closeModal = () => {
                modal.classList.add("hidden");
                document.removeEventListener("keydown", onEsc);
                modalOpener?.focus();
            };

            const onEsc = (e) => { if (e.key === "Escape") closeModal(); };

            openBtn.addEventListener("click", openModal);
            closeBtn.addEventListener("click", closeModal);
            overlay.addEventListener("click", closeModal);
            
            modal.addEventListener("click", (e) => {
                const btn = e.target.closest(".opt-btn");
                if (!btn) return;

                AppState.selectedProvider.category = btn.dataset.category;
                AppState.selectedProvider.provider = btn.dataset.provider;
                
                DOMElements.qs("#selectedProvider").textContent = `${btn.dataset.category} — ${btn.dataset.provider}`;
                openBtn.textContent = btn.dataset.provider;
                
                Utils.showToast(`Metode dipilih: ${btn.dataset.provider}`, 'info');
                closeModal();
            });
        },
        
        applyInputStyles() {
            const baseInputClass = "w-full rounded-lg px-3 py-2 bg-dark-bg-secondary text-dark-text ring-1 ring-dark-border focus:ring-accent";
            const baseOptBtnClass = "opt-btn h-12 rounded-lg bg-black/5 hover:bg-black/10 ring-1 ring-black/10 text-sm font-semibold";
            DOMElements.qsa('.form-input').forEach(el => el.className = baseInputClass);
            DOMElements.qsa('.opt-btn').forEach(el => el.className = baseOptBtnClass);
        },

        toggleSubmitSpinner(show) {
            const btn = DOMElements.qs("#submitBtn");
            const spinner = DOMElements.qs("#submit-spinner");
            const text = btn.querySelector("span");
            if (show) {
                btn.disabled = true;
                text.classList.add("opacity-0");
                spinner.classList.remove("hidden");
                spinner.classList.add("absolute", "animate-spin");
            } else {
                btn.disabled = false;
                text.classList.remove("opacity-0");
                spinner.classList.add("hidden");
                spinner.classList.remove("absolute", "animate-spin");
            }
        },

        resetForm() {
            DOMElements.qs("#orderForm").reset();
            AppState.selectedProvider = { category: null, provider: null };
            DOMElements.qs("#selectedProvider").textContent = "Belum dipilih";
            DOMElements.qs("#providerBtn").textContent = "Pilih Bank / E-Wallet";
            this.updateComputedIDR();
        }
    };
    
    // ====== VALIDATION ======
    const Validation = {
        isEmail: (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),
        isName: (v) => v && v.trim().length >= 3,
        isAcct: (v) => /^[a-zA-Z0-9.\-_ ]{5,}$/.test(v.trim()),
    };

    // ====== MAIN CONTROLLER ======
    const MainController = {
        async init() {
            ThemeManager.init();
            UIController.init();
            
            this.loadLiveRate();
            this.loadHistory();
            setInterval(() => this.loadLiveRate(), 10 * 60 * 1000); // Refresh every 10 mins
        },

        async loadLiveRate() {
            UIController.updateLiveRateUI(null); // Show loading state
            const result = await ApiService.getLiveRate();
            if (result) {
                AppState.liveRate = result.rate;
            }
            UIController.updateLiveRateUI(result);
        },

        async loadHistory() {
            UIController.showHistoryLoading();
            try {
                const data = await ApiService.getHistory();
                UIController.renderHistory(data);
            } catch (error) {
                console.error("[DB] Load history failed:", error);
                UIController.showHistoryError();
            }
        },
        
        async handleFormSubmit(e) {
            e.preventDefault();
            if (AppState.isSubmitting) return;

            AppState.isSubmitting = true;
            UIController.toggleSubmitSpinner(true);

            const formData = {
                name: DOMElements.qs("#name").value.trim(),
                email: DOMElements.qs("#paypal_email").value.trim(),
                type: DOMElements.qs("#type").value,
                account: DOMElements.qs("#account").value.trim(),
                usd: parseFloat(DOMElements.qs("#usd").value) || 0,
            };

            // Validation
            if (!AppState.selectedProvider.provider) {
                Utils.showToast("Pilih Bank / E-Wallet dulu.", 'error');
                return this.endSubmit();
            }
            if (!Validation.isName(formData.name)) {
                Utils.showToast("Nama lengkap minimal 3 karakter.", 'error');
                return this.endSubmit();
            }
            if (!Validation.isEmail(formData.email)) {
                Utils.showToast("Format email tidak valid.", 'error');
                return this.endSubmit();
            }
            if (!Validation.isAcct(formData.account)) {
                Utils.showToast("Nomor rekening/akun tidak valid.", 'error');
                return this.endSubmit();
            }
            if (!(formData.usd > 0)) {
                Utils.showToast("Nominal USD harus lebih dari 0.", 'error');
                return this.endSubmit();
            }

            const rate = UIController.getCurrentFixedRate();
            const idr = Math.round(formData.usd * rate);

            // Save to DB (best-effort)
            try {
                await ApiService.saveOrder({
                    ...formData,
                    rate,
                    receive_idr: idr,
                    target_type: AppState.selectedProvider.category,
                    provider: AppState.selectedProvider.provider,
                });
                Utils.showToast("Pesanan tersimpan, membuka WhatsApp...", 'success');
            } catch (err) {
                console.error("[DB] Insert failed:", err);
                Utils.showToast("Gagal menyimpan, tetap membuka WhatsApp.", 'error');
            }

            // Open WhatsApp
            const waMsg = [
                `Halo Admin Xkay Store, saya ingin ${formData.type}:`, ``,
                `Nama: ${formData.name}`,
                `Email PayPal: ${formData.email}`,
                `Kategori: ${AppState.selectedProvider.category}`,
                `Tujuan: ${AppState.selectedProvider.provider}`,
                `No. Akun: ${formData.account}`,
                `Nominal: ${Utils.formatNumber(formData.usd)} USD = ${Utils.formatCurrency(idr)} (kurs ${Utils.formatCurrency(rate)})`,
                `Kurs live saat ini: ${Utils.formatCurrency(AppState.liveRate)}`
            ].join("\n");
            
            const waUrl = `https://wa.me/${CONFIG.WA_ADMIN}?text=${encodeURIComponent(waMsg)}`;
            window.open(waUrl, "_blank", "noopener,noreferrer");

            UIController.resetForm();
            await this.loadHistory();
            this.endSubmit();
        },

        endSubmit() {
            AppState.isSubmitting = false;
            UIController.toggleSubmitSpinner(false);
        }
    };

    // ====== INITIALIZE APP ======
    document.addEventListener("DOMContentLoaded", () => MainController.init());

  </script>
</body>
</html>
