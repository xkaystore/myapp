<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xkay Store - Convert & Topup PayPal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <rect width='100' height='100' rx='20' ry='20' fill='%230d47a1'/>
      <text x='50%' y='55%' font-size='55' text-anchor='middle' fill='white' font-family='Arial'>X</text>
    </svg>
  "/>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Xkay Store</h1>
    <button id="darkToggle" class="px-3 py-1 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded">ðŸŒ™</button>
  </header>

  <!-- Kurs -->
  <section class="p-4 grid gap-2 text-center">
    <h2 class="text-lg font-semibold">Kurs</h2>
    <div class="grid gap-1">
      <p>Convert (Tetap): <span class="font-bold text-blue-700">Rp 12.000</span></p>
      <p>Topup (Tetap): <span class="font-bold text-blue-700">Rp 17.000</span></p>
      <p>Real-time: <span id="liveRate" class="font-bold text-green-600">Loading...</span></p>
    </div>
  </section>

  <!-- Form -->
  <section class="p-4">
    <form id="orderForm" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow grid gap-3 max-w-lg mx-auto">
      <h2 class="text-lg font-semibold">Form Order</h2>

      <select id="type" class="p-2 rounded border dark:bg-gray-700">
        <option value="convert">Convert Saldo</option>
        <option value="topup">Topup PayPal</option>
      </select>

      <input id="name" type="text" placeholder="Nama Lengkap" class="p-2 rounded border dark:bg-gray-700" required>
      <input id="paypalEmail" type="email" placeholder="Email PayPal" class="p-2 rounded border dark:bg-gray-700" required>
      
      <button type="button" onclick="openPopup()" class="p-2 bg-blue-600 text-white rounded">Pilih Bank / E-Wallet</button>
      <p id="selectedProvider" class="text-sm text-gray-500">Belum dipilih</p>

      <input id="account" type="text" placeholder="No Rekening / Akun" class="p-2 rounded border dark:bg-gray-700" required>
      <input id="usd" type="number" min="1" placeholder="Nominal USD" class="p-2 rounded border dark:bg-gray-700" required>

      <button type="submit" class="p-2 bg-green-600 text-white rounded hover:bg-green-700">Kirim Order</button>
    </form>
  </section>

  <!-- Popup Provider -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow max-w-sm w-full">
      <h3 class="font-semibold mb-2">Pilih Provider</h3>
      <div class="grid grid-cols-2 gap-2">
        <button onclick="selectProvider('Bank','BCA')" class="p-2 bg-blue-500 text-white rounded">BCA</button>
        <button onclick="selectProvider('Bank','BRI')" class="p-2 bg-blue-500 text-white rounded">BRI</button>
        <button onclick="selectProvider('E-Wallet','OVO')" class="p-2 bg-purple-500 text-white rounded">OVO</button>
        <button onclick="selectProvider('E-Wallet','Dana')" class="p-2 bg-purple-500 text-white rounded">Dana</button>
      </div>
      <button onclick="closePopup()" class="mt-3 px-3 py-1 bg-red-500 text-white rounded">Tutup</button>
    </div>
  </div>

  <!-- Riwayat -->
  <section class="p-4 flex-1">
    <h2 class="text-lg font-semibold mb-2">Riwayat Transaksi</h2>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
      <div class="overflow-y-auto max-h-80">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-200 dark:bg-gray-700">
            <tr>
              <th class="px-2 py-1">Tanggal</th>
              <th class="px-2 py-1">Type</th>
              <th class="px-2 py-1">Nama</th>
              <th class="px-2 py-1">USD</th>
              <th class="px-2 py-1">IDR</th>
              <th class="px-2 py-1">Provider</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow hidden">Order berhasil dikirim!</div>

  <!-- Script -->
  <script type="module">
    const SUPABASE_URL = "https://rhujpinlutjiztyonmas.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const WA_ADMIN = "6285846005280";

    const FIXED_RATE_CONVERT = 12000;
    const FIXED_RATE_TOPUP = 17000;

    let selectedCategory = null;
    let selectedProvider = null;

    // Popup
    function openPopup() { document.getElementById("popup").style.display = "flex"; }
    function closePopup() { document.getElementById("popup").style.display = "none"; }
    window.selectProvider = (cat, prov) => {
      selectedCategory = cat; selectedProvider = prov;
      document.getElementById("selectedProvider").innerText = `${cat} - ${prov}`;
      closePopup();
    };

    // Fetch Kurs Real-time
    async function fetchRate() {
      let rate = null;
      try {
        const r1 = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=IDR");
        if (r1.ok) { rate = (await r1.json()).rates.IDR; }
      } catch {}
      if (!rate) {
        try {
          const r2 = await fetch("https://open.er-api.com/v6/latest/USD");
          if (r2.ok) { rate = (await r2.json()).rates.IDR; }
        } catch {}
      }
      document.getElementById("liveRate").innerText = rate ? "Rp " + rate.toLocaleString() : "Gagal ambil kurs";
    }
    fetchRate();

    // Toast
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.classList.remove("hidden");
      setTimeout(()=>toast.classList.add("hidden"),3000);
    }

    // Load History
    async function loadHistory() {
      const { data } = await supabaseClient.from("orders").select("*").order("created_at",{ascending:false}).limit(20);
      const tbody = document.getElementById("historyTable");
      tbody.innerHTML = "";
      data.forEach(row=>{
        tbody.innerHTML += `
          <tr class="border-b dark:border-gray-700">
            <td class="px-2 py-1">${new Date(row.created_at).toLocaleString()}</td>
            <td class="px-2 py-1">${row.type}</td>
            <td class="px-2 py-1">${row.name}</td>
            <td class="px-2 py-1">${row.usd}</td>
            <td class="px-2 py-1">Rp ${row.receive_idr.toLocaleString()}</td>
            <td class="px-2 py-1">${row.provider}</td>
          </tr>`;
      });
    }
    loadHistory();

    // Form
    document.getElementById("orderForm").addEventListener("submit", async(e)=>{
      e.preventDefault();
      const type = document.getElementById("type").value;
      const name = document.getElementById("name").value.trim();
      const paypalEmail = document.getElementById("paypalEmail").value.trim();
      const usd = parseFloat(document.getElementById("usd").value);
      const account = document.getElementById("account").value.trim();

      if(!name || !paypalEmail || !usd || !account || !selectedProvider) {
        showToast("Harap lengkapi semua data");
        return;
      }
      if(!paypalEmail.includes("@")) { showToast("Email tidak valid"); return; }

      const rate = type==="convert"?FIXED_RATE_CONVERT:FIXED_RATE_TOPUP;
      const receive_idr = usd * rate;

      const { error } = await supabaseClient.from("orders").insert([{
        type, name, paypal_email:paypalEmail, usd, rate, receive_idr,
        target_type:selectedCategory, provider:selectedProvider, account
      }]);
      if(error){ showToast("Gagal simpan order"); return; }

      // WA
      const msg = `Halo Admin, saya ingin ${type} PayPal:\nNama: ${name}\nEmail: ${paypalEmail}\nUSD: ${usd}\nKurs: Rp${rate}\nTerima: Rp${receive_idr}\n${selectedCategory}: ${selectedProvider}\nAkun: ${account}`;
      window.open(`https://wa.me/${WA_ADMIN}?text=${encodeURIComponent(msg)}`,"_blank");

      e.target.reset();
      document.getElementById("selectedProvider").innerText="Belum dipilih";
      selectedCategory=null; selectedProvider=null;
      loadHistory();
      showToast("Order berhasil dikirim!");
    });

    // Dark Mode
    document.getElementById("darkToggle").addEventListener("click",()=>{
      document.documentElement.classList.toggle("dark");
    });
  </script>
</body>
</html>
