<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xkay Store | Convert & Topup PayPal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <!-- Favicon Xkay Store -->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <rect width='100' height='100' rx='20' ry='20' fill='%230d47a1'/>
      <text x='50%' y='55%' font-size='55' text-anchor='middle' fill='white' font-family='Arial, sans-serif'>X</text>
    </svg>
  "/>
</head>
<body class="bg-blue-900 text-white font-sans min-h-screen">

  <!-- Header -->
  <header class="text-center p-6 bg-blue-800 shadow-md">
    <h1 class="text-3xl font-bold">Xkay Store</h1>
    <p class="mt-2">ðŸ’¸ Convert & Topup PayPal dengan mudah</p>
    <div class="mt-3 space-y-1">
      <p>Kurs Tetap: <span id="fixedRate" class="font-semibold">Rp 12.000</span></p>
      <p>Kurs Real-Time: <span id="liveRate" class="font-semibold">Loading...</span></p>
    </div>
  </header>

  <!-- Form -->
  <main class="p-6">
    <div class="bg-blue-800 rounded-2xl shadow-lg p-6 max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-4">Form Order</h2>
      <form id="orderForm" class="space-y-4">
        <input type="text" id="name" placeholder="Nama Lengkap" class="w-full p-3 rounded text-black" required>
        <input type="email" id="paypal_email" placeholder="Email PayPal" class="w-full p-3 rounded text-black" required>
        
        <div>
          <label class="block mb-2">Jenis Transaksi:</label>
          <select id="type" class="w-full p-3 rounded text-black" required>
            <option value="convert">Convert (PayPal â†’ Bank/E-Wallet)</option>
            <option value="topup">Topup (Bank/E-Wallet â†’ PayPal)</option>
          </select>
        </div>

        <div>
          <label class="block mb-2">Pilih Kategori:</label>
          <button type="button" onclick="openPopup()" class="bg-blue-600 px-4 py-2 rounded">Pilih Bank / E-Wallet</button>
          <p id="selectedProvider" class="mt-2 italic text-gray-300">Belum dipilih</p>
        </div>

        <input type="text" id="account" placeholder="No Rekening / Akun" class="w-full p-3 rounded text-black" required>

        <div>
          <input type="number" id="usd" placeholder="Nominal (USD)" class="w-full p-3 rounded text-black" required>
          <p class="mt-2">Setara (kurs tetap): <span id="idr">Rp 0</span></p>
        </div>

        <button type="submit" class="bg-green-600 px-6 py-3 rounded-lg w-full">Kirim Order</button>
      </form>
    </div>
  </main>

  <!-- Riwayat -->
  <section class="p-6">
    <div class="bg-blue-800 rounded-2xl shadow-lg p-6 max-w-4xl mx-auto">
      <h2 class="text-xl font-bold mb-4">Riwayat Transaksi</h2>
      <table class="w-full text-left text-sm">
        <thead>
          <tr>
            <th class="p-2">Tanggal</th>
            <th class="p-2">Nama</th>
            <th class="p-2">Tipe</th>
            <th class="p-2">Kategori</th>
            <th class="p-2">Provider</th>
            <th class="p-2">USD</th>
            <th class="p-2">IDR</th>
          </tr>
        </thead>
        <tbody id="history" class="divide-y divide-blue-700"></tbody>
      </table>
      <button onclick="exportCSV()" class="mt-4 bg-yellow-500 px-4 py-2 rounded text-black">Export CSV</button>
    </div>
  </section>

  <!-- Popup Provider -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center">
    <div class="bg-white text-black p-6 rounded-2xl max-w-md w-full">
      <h3 class="text-lg font-bold mb-4">Pilih Bank / E-Wallet</h3>
      <p class="mb-2 font-semibold">Bank Lokal</p>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <button onclick="selectProvider('Bank Lokal','BCA')" class="p-3 bg-blue-200 rounded">BCA</button>
        <button onclick="selectProvider('Bank Lokal','BRI')" class="p-3 bg-blue-200 rounded">BRI</button>
        <button onclick="selectProvider('Bank Lokal','BNI')" class="p-3 bg-blue-200 rounded">BNI</button>
        <button onclick="selectProvider('Bank Lokal','Mandiri')" class="p-3 bg-blue-200 rounded">Mandiri</button>
      </div>
      <p class="mb-2 font-semibold">E-Wallet</p>
      <div class="grid grid-cols-2 gap-4">
        <button onclick="selectProvider('E-Wallet','OVO')" class="p-3 bg-green-200 rounded">OVO</button>
        <button onclick="selectProvider('E-Wallet','Dana')" class="p-3 bg-green-200 rounded">Dana</button>
        <button onclick="selectProvider('E-Wallet','Gopay')" class="p-3 bg-green-200 rounded">Gopay</button>
        <button onclick="selectProvider('E-Wallet','ShopeePay')" class="p-3 bg-green-200 rounded">ShopeePay</button>
      </div>
      <button onclick="closePopup()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Tutup</button>
    </div>
  </div>

<script type="module">
  // ====== KONFIGURASI ======
  const SUPABASE_URL = "https://rhujpinlutjiztyonmas.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJodWpwaW5sdXRqaXp0eW9ubWFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDQyOTIsImV4cCI6MjA3Mjg4MDI5Mn0.zcfDUOHTeBYydFFscwmy3U9yryHiItTVJPLRurUlBvY";
  const DEFAULT_RATE = 12000; // Kurs tetap
  const WA_ADMIN = "6285846005280";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let currentLiveRate = DEFAULT_RATE;
  let selectedCategory = null;
  let selectedProvider = null;

  // ====== Fetch Kurs Real-Time ======
  async function fetchRate() {
    try {
      const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=IDR");
      const data = await res.json();
      currentLiveRate = data.rates.IDR || DEFAULT_RATE;
    } catch {
      currentLiveRate = DEFAULT_RATE;
    }
    document.getElementById("fixedRate").innerText = "Rp " + DEFAULT_RATE.toLocaleString();
    document.getElementById("liveRate").innerText = "Rp " + currentLiveRate.toLocaleString();
  }
  fetchRate();

  // ====== Popup ======
  function openPopup() {
    document.getElementById("popup").style.display = "flex";
  }
  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }
  window.selectProvider = (category, provider) => {
    selectedCategory = category;
    selectedProvider = provider;
    document.getElementById("selectedProvider").innerText = `${category} - ${provider}`;
    closePopup();
  };

  // ====== Form Handling ======
  document.getElementById("usd").addEventListener("input", e => {
    const usd = parseFloat(e.target.value) || 0;
    const idr = usd * DEFAULT_RATE;
    document.getElementById("idr").innerText = "Rp " + idr.toLocaleString();
  });

  document.getElementById("orderForm").addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const paypal_email = document.getElementById("paypal_email").value;
    const type = document.getElementById("type").value;
    const usd = parseFloat(document.getElementById("usd").value);
    const idr = usd * DEFAULT_RATE;
    const account = document.getElementById("account").value;

    if (!selectedProvider) {
      alert("Pilih Bank atau E-Wallet dulu!");
      return;
    }

    // Simpan ke Supabase
    await supabaseClient.from("orders").insert([{
      type, name, paypal_email,
      usd, rate: DEFAULT_RATE, receive_idr: idr,
      target_type: selectedCategory, provider: selectedProvider, account
    }]);

    // Kirim ke WA
    const waText = `Halo Admin Xkay Store, saya ingin ${type}:\nNama: ${name}\nEmail PayPal: ${paypal_email}\nKategori: ${selectedCategory}\nProvider: ${selectedProvider}\nAkun: ${account}\nNominal: ${usd} USD = Rp ${idr.toLocaleString()} (kurs tetap Rp ${DEFAULT_RATE.toLocaleString()})\n\nKurs real-time saat ini: Rp ${currentLiveRate.toLocaleString()}`;
    window.open(`https://wa.me/${WA_ADMIN}?text=${encodeURIComponent(waText)}`, "_blank");

    e.target.reset();
    document.getElementById("selectedProvider").innerText = "Belum dipilih";
    fetchHistory();
  });

  // ====== Riwayat ======
  async function fetchHistory() {
    const { data } = await supabaseClient.from("orders").select("*").order("created_at", { ascending: false });
    const tbody = document.getElementById("history");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2">${new Date(row.created_at).toLocaleString()}</td>
        <td class="p-2">${row.name}</td>
        <td class="p-2">${row.type}</td>
        <td class="p-2">${row.target_type}</td>
        <td class="p-2">${row.provider}</td>
        <td class="p-2">${row.usd}</td>
        <td class="p-2">Rp ${row.receive_idr.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  fetchHistory();

  // ====== Export CSV ======
  async function exportCSV() {
    const { data } = await supabaseClient.from("orders").select("*");
    let csv = "Tanggal,Nama,Tipe,Kategori,Provider,USD,IDR\n";
    data.forEach(row => {
      csv += `${row.created_at},${row.name},${row.type},${row.target_type},${row.provider},${row.usd},${row.receive_idr}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "riwayat.csv";
    a.click();
  }
</script>
</body>
</html>
